# ubuntu:xenial该基础镜像会被Dockerfile构建出的镜像替换，由jenkins上填写构建出的镜像名替换
FROM ubuntu:xenial

# Set env
USER root
ENV USER root


# install java
RUN wget --no-cookies --no-check-certificate --header "Cookie: gpw_e24=http%3A%2F%2Fwww.oracle.com%2F; oraclelicense=accept-securebackup-cookie" "http://download.oracle.com/otn-pub/java/jdk/8u141-b15/336fa29ff2bb4ef291e347e091f7f4a7/jdk-8u141-linux-x64.tar.gz"
RUN mkdir /usr/local/java
RUN tar zxvf jdk-8u141-linux-x64.tar.gz -C /usr/local/java
RUN ln -s /usr/local/java/jdk1.8.0_141 /usr/local/java/jdk
ENV JAVA_HOME /usr/local/java/jdk
ENV JRE_HOME ${JAVA_HOME}/jre
ENV CLASSPATH .:${JAVA_HOME}/lib:${JRE_HOME}/lib
ENV PATH ${JAVA_HOME}/bin:$PATH

# install obsutil
RUN wget https://obs-community.obs.cn-north-1.myhuaweicloud.com/obsutil/current/obsutil_linux_amd64.tar.gz
RUN mkdir -p /usr/local/obsutil/obsutil_linux_amd64
RUN tar -xzvf obsutil_linux_amd64.tar.gz -C /usr/local/obsutil/obsutil_linux_amd64 --strip-components 1
RUN ln -s /usr/local/obsutil/obsutil_linux_amd64/obsutil /usr/bin/obsutil
RUN chmod 755 /usr/local/obsutil/obsutil_linux_amd64/obsutil

# app-publish
RUN git clone -b mindspore https://github.com/7Light/app-publish.git
WORKDIR /app-publish
RUN mvn clean install -s settings.xml

# clam
RUN touch /etc/clamd.d/scan.conf
RUN chmod 755 /etc/clamd.d/scan.conf
RUN echo 'LogFile /var/log/clamav/scan.log' >> /etc/clamd.d/scan.conf
RUN echo 'LogFileMaxSize 0' >> /etc/clamd.d/scan.conf
RUN echo 'LogTime yes' >> /etc/clamd.d/scan.conf
RUN echo 'LogSyslog yes' >> /etc/clamd.d/scan.conf
RUN echo 'DatabaseDirectory /var/lib/clamav' >> /etc/clamd.d/scan.conf
RUN echo 'ScanArchive yes' >> /etc/clamd.d/scan.conf
RUN echo 'MaxFileSize 200M' >> /etc/clamd.d/scan.conf
RUN echo 'MaxRecursion 16' >> /etc/clamd.d/scan.conf
RUN echo 'MaxFiles 10000' >> /etc/clamd.d/scan.conf
RUN echo 'MaxEmbeddedPE 10M' >> /etc/clamd.d/scan.conf
RUN echo 'MaxHTMLNormalize 10M' >> /etc/clamd.d/scan.conf
RUN freshclam



# install rasp.tgz
WORKDIR /usr/local/
ARG RASP_USER_NAME
ARG RASP_PASSWORD
RUN git clone  https://${RASP_USER_NAME}:${RASP_PASSWORD}@github.com/Open-Infra-Ops/plugins.git
WORKDIR /plugins/armorrasp/
RUN tar -xzvf rasp.tgz -C /usr/local/
RUN remove -r /usr/local/plugins/
RUN chmod 755 -R /usr/local/rasp/

WORKDIR /usr/local
RUN touch entrypoint.sh
RUN echo '#!/bin/bash' >> /usr/local/entrypoint.sh
RUN sed -i -e "1a/usr/local/obsutil/obsutil_linux_amd64/obsutil config -i=\$ak -k=\$sk -e=\$endpoint" /usr/local/entrypoint.sh
RUN sed -i -e "2ajava -javaagent:/usr/local/rasp/rasp.jar -jar /root/.m2/repository/com/huawei/app-publish/1.0/app-publish-1.0.jar" /usr/local/entrypoint.sh
RUN chmod u+x /usr/local/entrypoint.sh
ENTRYPOINT ["/usr/local/entrypoint.sh"]

